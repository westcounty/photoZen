# PhotoZen 第2层规划 - 模块详细方案索引

> 生成日期: 2026-01-25
> 父文档: [PLAN_L1_OVERVIEW.md](./PLAN_L1_OVERVIEW.md)
> 需求文档: [REQUIREMENTS_LISTING.md](./REQUIREMENTS_LISTING.md)

---

## 架构优化说明

基于软件架构最佳实践，对原有模块划分进行以下优化：

### 分层架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Layer 4: 收尾优化层                           │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  模块I: 撤销功能、状态指示器、标题优化、Bug修复、新手引导      │   │
│  └─────────────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────────────┤
│                        Layer 3: 业务页面层                           │
│  ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐     │
│  │模块C  │ │模块D  │ │模块E  │ │模块F  │ │模块G  │ │模块H  │     │
│  │待定   │ │回收站 │ │已保留 │ │相册   │ │时间线 │ │筛选   │     │
│  └───┬───┘ └───┬───┘ └───┬───┘ └───┬───┘ └───┬───┘ └───┬───┘     │
│      └─────────┴─────────┴────┬────┴─────────┴─────────┘          │
│                               │                                     │
├───────────────────────────────┼─────────────────────────────────────┤
│                        Layer 2: 核心功能层                           │
│                   ┌───────────┴───────────┐                        │
│                   │      模块B: 全屏预览    │                        │
│                   │  (统一预览组件,被复用)   │                        │
│                   └───────────────────────┘                        │
├─────────────────────────────────────────────────────────────────────┤
│                        Layer 1: 基础设施层                           │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    模块A: 通用视图组件                        │   │
│  │  ├── A1: 网格/瀑布流视图 + 双指缩放列数切换                    │   │
│  │  ├── A2: 排序按钮交互统一                                     │   │
│  │  └── A3: 底部操作栏规范化                                     │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

### 优化后的实施顺序

| 阶段 | 模块 | 说明 | 预计周期 |
|-----|------|------|---------|
| **Phase 1** | 模块A | 基础设施层，为所有后续模块提供组件 | - |
| **Phase 2** | 模块B | 核心功能层，统一全屏预览被所有列表复用 | - |
| **Phase 3a** | 模块F+G | 相册+时间线列表(功能高度相似，共享实现) | - |
| **Phase 3b** | 模块E | 已保留列表(中等复杂度) | - |
| **Phase 3c** | 模块C+D | 待定+回收站列表(较简单) | - |
| **Phase 3d** | 模块H | 筛选列表优化 | - |
| **Phase 4** | 模块I | 收尾优化 | - |

---

## 模块方案文档索引

| 模块 | 文档路径 | 状态 | 需求覆盖 |
|-----|---------|------|---------|
| A | [PLAN_L2_MODULE_A.md](./PLAN_L2_MODULE_A.md) | ✅ **已完成** | REQ-001~011, 022~027 (17项) |
| B | [PLAN_L2_MODULE_B.md](./PLAN_L2_MODULE_B.md) | ✅ **已完成** | REQ-012~021 (10项) |
| C+D | [PLAN_L2_MODULE_C_D.md](./PLAN_L2_MODULE_C_D.md) | ✅ **已完成** | REQ-028~036 (9项) |
| E | [PLAN_L2_MODULE_E.md](./PLAN_L2_MODULE_E.md) | ✅ **已完成** | REQ-037~043 (7项) |
| F+G | [PLAN_L2_MODULE_F_G.md](./PLAN_L2_MODULE_F_G.md) | ✅ **已完成** | REQ-044~056 (13项) |
| H | [PLAN_L2_MODULE_H.md](./PLAN_L2_MODULE_H.md) | ✅ **已完成** | REQ-057~058 (2项) |
| I | [PLAN_L2_MODULE_I.md](./PLAN_L2_MODULE_I.md) | ✅ **已完成** | REQ-059~067 (9项) |

> 注: 模块C+D、F+G因功能高度相似而合并规划，共享实现以减少代码重复

---

## 关键设计决策记录

### DD-001: 双指缩放手势实现策略
- **决策**: 采用双指缩放手势切换列数，参考 Google Photos 最佳实践
- **原因**: 用户体验更自然，符合直觉
- **实现要点**: 使用 `transformable` modifier + 阈值检测
- **回退方案**: 若体验不佳，可叠加顶栏按钮作为辅助

### DD-002: 全屏预览组件统一化
- **决策**: 创建统一的 `UnifiedFullscreenViewer` 组件
- **原因**: 避免各列表页面重复实现，确保体验一致
- **影响**: 所有列表页面(C-H)使用同一组件

### DD-003: 列表页面配置化
- **决策**: 创建 `PhotoListConfig` 配置类，通过配置差异化各列表行为
- **原因**: 减少代码重复，提高可维护性
- **配置项**: 排序选项、底部操作、选择限制等

### DD-004: 撤销架构统一化 (REQ-060)
- **决策**: 废弃 FlowSorterViewModel 内部的撤销逻辑，统一使用全局 `UndoManager`
- **原因**:
  - 现有两套撤销机制并存，架构不统一
  - `keepAndAddToAlbum` 无法撤销，需要支持
  - 便于未来扩展多步撤销
- **实现要点**:
  - 扩展 `UndoAction` 类型：新增 `SortPhoto`, `AlbumOperation`, `KeepAndAddToAlbum`
  - `UndoManager` 改用栈结构（当前限制1步，预留扩展）
  - 撤销时恢复到原状态（而非固定 UNSORTED）
- **影响文件**:
  - `domain/model/UndoAction.kt`
  - `ui/state/UndoManager.kt`
  - `ui/screens/flowsorter/FlowSorterViewModel.kt`
- **详细方案**: 见 [PLAN_L2_MODULE_I.md](./PLAN_L2_MODULE_I.md) REQ-060 章节

---

## 验证清单模板

每个模块完成后需要验证：

```markdown
## 模块X 完成验证

### 需求覆盖
- [ ] REQ-XXX: 描述 ← 文件:行号

### 编译状态
- [ ] compileStandardDebugKotlin 成功

### 功能测试
- [ ] 场景1: 描述
- [ ] 场景2: 描述

### 未完成项
- REQ-XXX 延至模块Y实现
```
