# 复杂任务多层拆解工作流程

> 📌 更新日期: 2026-01-25 | AI 协作开发指南

本文档描述了处理复杂开发任务的推荐工作流程，确保需求不遗漏、实现可追溯、验证有保障。

---

## 问题背景

  您即将提供一个非常长的 prompt，包含各个列表的操作以及不同状态下照片的操作描述。需要确保：
  1. 实现过程中不会遗漏任何细节
  2. 多层拆解并可自动执行
  3. 每层每步都包含原始需求引用，避免上下文压缩影响
  4. 每步及最终都有严格的验证机制

  ---

  ## 推荐的工作流程：三层拆解 + 检查点验证

  ### 流程概览

  ```
  ┌─────────────────────────────────────────────────────────────────┐
  │ 第 0 层：原始需求文档化                                           │
  │ ├── 将您的长 prompt 保存为独立文件（如 REQUIREMENTS.md）           │
  │ └── 后续每层计划都引用此文件，避免上下文丢失                        │
  └─────────────────────────────────────────────────────────────────┘
  ↓
  ┌─────────────────────────────────────────────────────────────────┐
  │ 第 1 层：总体规划（Strategic Plan）                               │
  │ ├── 拆解为 N 个主要模块/功能域                                    │
  │ ├── 每个模块包含：目标、涉及文件、依赖关系                          │
  │ └── 输出：PLAN_L1_OVERVIEW.md                                    │
  │     └── 检查点 1：确认模块划分是否覆盖所有需求                      │
  └─────────────────────────────────────────────────────────────────┘
  ↓
  ┌─────────────────────────────────────────────────────────────────┐
  │ 第 2 层：详细方案（每个模块单独规划）                               │
  │ ├── 模块 1 详细方案 → PLAN_L2_MODULE_1.md                        │
  │ ├── 模块 2 详细方案 → PLAN_L2_MODULE_2.md                        │
  │ └── ...                                                         │
  │ 每个方案包含：                                                    │
  │   - 原始需求摘录（从 REQUIREMENTS.md 复制相关段落）                 │
  │   - 具体实现步骤                                                  │
  │   - 代码变更清单（文件 + 函数 + 变更内容）                          │
  │   - 验证标准                                                      │
  │     └── 检查点 2：确认方案覆盖该模块所有需求点                      │
  └─────────────────────────────────────────────────────────────────┘
  ↓
  ┌─────────────────────────────────────────────────────────────────┐
  │ 第 3 层：执行与验证（逐模块实施）                                   │
  │ ├── 实施模块 1                                                   │
  │ │   ├── 执行代码变更                                              │
  │ │   ├── 编译验证                                                  │
  │ │   └── 检查点 3a：对照 PLAN_L2_MODULE_1.md 逐项验证              │
  │ ├── 实施模块 2                                                   │
  │ │   └── ...                                                     │
  │ └── 最终检查点：对照 REQUIREMENTS.md 全量验收                      │
  └─────────────────────────────────────────────────────────────────┘
  ```

  ---

  ## 具体操作方式

  ### 方式一：使用需求文件 + 分阶段提示（推荐）

  **步骤 1：创建需求文件**
  ```
  您先发送长 prompt，我会：
  1. 将完整需求保存到 docs/REQUIREMENTS_XXX.md
  2. 解析并创建结构化的需求清单
  3. 为每个需求点编号（如 REQ-001, REQ-002...）
  ```

  **步骤 2：第一层规划**
  ```
  我会创建总体规划，您可以说：
  "请制定第一层规划，将需求拆解为主要模块"

  我会输出类似：
  - 模块 A：列表操作统一（涉及 REQ-001~REQ-015）
  - 模块 B：照片状态机（涉及 REQ-016~REQ-030）
  - 模块 C：批量操作（涉及 REQ-031~REQ-045）
  ...
  ```

  **步骤 3：第二层规划（逐模块）**
  ```
  对每个模块，您可以说：
  "请制定模块 A 的详细实施方案"

  我会输出包含原始需求引用的详细方案
  ```

  **步骤 4：执行与验证**
  ```
  "请实施模块 A 并进行验证"

  我会：
  1. 执行代码变更
  2. 编译验证
  3. 输出检查清单，逐项标记完成状态
  ```

  ---

  ### 方式二：使用 TodoList 自动跟踪

  **优势**：内置进度追踪，不会遗漏

  ```
  我可以使用 TaskCreate/TaskUpdate 工具：

  1. 解析需求后创建主任务列表
  2. 每个主任务下创建子任务
  3. 执行时自动标记进度
  4. 最后生成完成报告
  ```

  ---

  ## 您需要提供的内容格式建议

  为了最大化解析准确性，建议您的 prompt 包含：

  ```markdown
  # 照片操作系统需求规格

  ## 一、列表类型定义
  | 列表名称 | 数据来源 | 筛选条件 | 排序规则 |
  |---------|---------|---------|---------|
  | 待整理列表 | photos 表 | status=UNSORTED | date_taken DESC |
  | ...

  ## 二、列表操作矩阵
  | 操作名称 | 适用列表 | 触发方式 | 操作结果 | 可否撤销 |
  |---------|---------|---------|---------|---------|
  | 标记保留 | 待整理 | 右滑/点击按钮 | status→KEEP | 是 |
  | ...

  ## 三、状态转换规则
  | 当前状态 | 可执行操作 | 目标状态 | 附加逻辑 |
  |---------|-----------|---------|---------|
  | UNSORTED | 保留 | KEEP | 更新统计 |
  | ...

  ## 四、UI 交互规范
  ### 4.1 手势定义
  - 右滑：保留
  - ...

  ### 4.2 按钮行为
  ...
  ```

  ---

  ## 验证机制详解

  ### 每层验证内容

  | 层级 | 验证时机 | 验证内容 | 验证方式 |
  |-----|---------|---------|---------|
  | L1 | 规划完成后 | 模块划分是否覆盖全部需求 | 需求编号对照 |
  | L2 | 方案完成后 | 实施步骤是否覆盖模块所有需求点 | 清单勾选 |
  | L3 | 每模块完成后 | 代码是否符合方案 | 编译+功能测试 |
  | 最终 | 全部完成后 | 是否完全符合原始需求 | 全量回归验证 |

  ### 验证输出示例

  ```markdown
  ## 模块 A 完成验证报告

  ### 需求覆盖检查
  - [x] REQ-001: 待整理列表支持右滑保留 ← FlowSorterScreen.kt:234
  - [x] REQ-002: 保留后显示动画反馈 ← PhotoCard.kt:89
  - [x] REQ-003: 支持撤销操作 ← FlowSorterViewModel.kt:456
  - [ ] REQ-004: 批量保留时显示进度 ← 待实现

  ### 编译状态
  ✅ compileStandardDebugKotlin 成功

  ### 未覆盖项
  - REQ-004 将在模块 C 中实现（批量操作模块）
  ```

  ---

  ## 建议的下一步

  请您：

  1. **直接发送长 prompt**
  - 我会先将其保存为需求文件
  - 然后进行第一层拆解规划
  - 规划完成后请您确认再进行下一步

  2. **或者先描述需求的大致范围**
  - 我可以先提供一个更针对性的工作流程模板

  ---

  ## 关于上下文压缩的对策

  1. **需求文件持久化**：原始需求保存在文件中，每次可重新读取
  2. **每层计划独立文件**：避免单文件过长被压缩
  3. **需求编号引用**：使用 REQ-XXX 编号，不复制全文
  4. **阶段性汇总**：每完成一个模块，输出进度汇总

  ---

  ## 总结

  推荐流程：
  ```
  发送需求 → 保存为文件 → L1规划 → 确认 → L2逐模块规划 → 确认 → L3逐模块实施+验证 → 最终验收
  ```

  每个 "→ 确认" 都是您可以介入检查的点。

  请直接发送您的长 prompt，我将按照上述流程开始处理。